
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Key-Value Store How-To &#8212; CCF  documentation</title>
    
  <link rel="stylesheet" href="../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="KV Serialisation" href="kv_serialisation.html" />
    <link rel="prev" title="Key-Value Store" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

    
    <a class="navbar-brand" href="../../index.html">
      <img src="../../_static/ccf.svg" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-11 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../overview/index.html">Overview</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../index.html">Build Apps</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../use_apps/index.html">Use Apps</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../operations/index.html">Operations</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../governance/index.html">Governance</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../audit/index.html">Audit</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../contribute/index.html">Contribute</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../glossary.html">Glossary</a>
        </li>
        
        
      </ul>

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/Microsoft/CCF" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<script>
    function onVersionChange() {
      window.location.href = document.getElementById("versions").value;
    }

    window.addEventListener("DOMContentLoaded",function(){
        let selectedVersion = "master"
        const thisURL = window.location.toString()
        let indexOfVersion = thisURL.indexOf("ccf-")
        if (indexOfVersion != -1) {
            selectedVersion = thisURL.substring(indexOfVersion, thisURL.indexOf("/", indexOfVersion));
        }
        let sel = document.getElementById("versions");
        if (sel != null) {
            let opts = sel.options;
            for (var opt, j = 0; opt = opts[j]; j++) {
                if (opt.text == selectedVersion) {
                    sel.selectedIndex = j;
                    break;
                }
            }
        }
    }, false);
</script>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
        

        <ul class="nav bd-sidenav">
            
            
            
            
            
            
            <li class="">
                <a href="../create_vm.html">Create Azure SGX VM</a>
            </li>
            
            
            
            <li class="">
                <a href="../install_bin.html">Install CCF</a>
            </li>
            
            
            
            <li class="">
                <a href="../build_setup.html">CCF Development Setup</a>
            </li>
            
            
            
            <li class="">
                <a href="../example.html">C++ Application</a>
            </li>
            
            
            
            <li class="">
                <a href="../js_app.html">JavaScript Application</a>
            </li>
            
            
            
            <li class="">
                <a href="../build_app.html">Build and Sign CCF Applications</a>
            </li>
            
            
            
            <li class="">
                <a href="../run_app.html">Running CCF Applications</a>
            </li>
            
            
            
            <li class="">
                <a href="../demo.html">End-to-end demo</a>
            </li>
            
            
            
            <li class="">
                <a href="../auth/index.html">User Authentication</a>
            </li>
            
            
            

            <li class="active">
                <a href="index.html">Key-Value Store</a>
                <ul>
                    
                    <li class="active">
                        <a href="">Key-Value Store How-To</a>
                    </li>
                    
                    <li class="">
                        <a href="kv_serialisation.html">KV Serialisation</a>
                    </li>
                    
                    <li class="">
                        <a href="api.html">Key-Value Store API</a>
                    </li>
                    
                </ul>
            </li>
            
            
            
            <li class="">
                <a href="../upgrading_app.html">Upgrade Your Application</a>
            </li>
            
            
            
            <li class="">
                <a href="../api.html">Developer API</a>
            </li>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </ul>

        
        <h6> Versions </h6>
        <select name="versions" id="versions" class="custom-select custom-select-sm" style="width:50%" onchange="onVersionChange()">
            <option value="../../../master/build_apps/kv/kv_how_to.html">master </option>
            <option value="../../../ccf-0.17.2/build_apps/kv/kv_how_to.html">ccf-0.17.2 </option>
            <option value="../../../ccf-0.17.1/build_apps/kv/kv_how_to.html">ccf-0.17.1 </option>
            <option value="kv_how_to.html">ccf-0.17.0 </option>
            <option value="../../../ccf-0.16.3/build_apps/kv/kv_how_to.html">ccf-0.16.3 </option>
            <option value="../../../ccf-0.16.2/build_apps/kv/kv_how_to.html">ccf-0.16.2 </option>
            <option value="../../../ccf-0.16.1/build_apps/kv/kv_how_to.html">ccf-0.16.1 </option>
            <option value="../../../ccf-0.16.0/build_apps/kv/kv_how_to.html">ccf-0.16.0 </option>
            <option value="../../../ccf-0.15.2/index.html">ccf-0.15.2 </option>
            <option value="../../../ccf-0.15.1/index.html">ccf-0.15.1 </option>
            <option value="../../../ccf-0.15.0/index.html">ccf-0.15.0 </option>
            <option value="../../../ccf-0.14.3/index.html">ccf-0.14.3 </option>
            <option value="../../../ccf-0.14.2/index.html">ccf-0.14.2 </option>
            <option value="../../../ccf-0.14.1/index.html">ccf-0.14.1 </option>
            <option value="../../../ccf-0.14.0/index.html">ccf-0.14.0 </option>
            <option value="../../../ccf-0.13.4/index.html">ccf-0.13.4 </option>
            <option value="../../../ccf-0.13.3/index.html">ccf-0.13.3 </option>
            <option value="../../../ccf-0.13.2/index.html">ccf-0.13.2 </option>
            <option value="../../../ccf-0.13.1/index.html">ccf-0.13.1 </option>
            <option value="../../../ccf-0.13.0/index.html">ccf-0.13.0 </option>
            <option value="../../../ccf-0.12.2/index.html">ccf-0.12.2 </option>
            <option value="../../../ccf-0.12.1/index.html">ccf-0.12.1 </option>
            <option value="../../../ccf-0.12.0/index.html">ccf-0.12.0 </option>
            <option value="../../../ccf-0.11.7/index.html">ccf-0.11.7 </option>
            <option value="../../../ccf-0.11.4/index.html">ccf-0.11.4 </option>
            <option value="../../../ccf-0.11.1/index.html">ccf-0.11.1 </option>
        </select>
        
</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#creating-a-map" class="nav-link">Creating a Map</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#accessing-the-transaction" class="nav-link">Accessing the Transaction</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#modifying-a-view" class="nav-link">Modifying a View</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#read-only-views" class="nav-link">Read-only views</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#removing-a-key" class="nav-link">Removing a key</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#global-commit" class="nav-link">Global commit</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#miscellaneous" class="nav-link">Miscellaneous</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#foreach" class="nav-link">foreach()</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#applying-and-reverting-writes" class="nav-link">Applying and reverting writes</a>
        </li>
    
            </ul>
        </li>
    
    </ul>
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/Microsoft/CCF/edit/master/doc/build_apps/kv/kv_how_to.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="key-value-store-how-to">
<h1>Key-Value Store How-To<a class="headerlink" href="#key-value-store-how-to" title="Permalink to this headline">¶</a></h1>
<p>The Key-Value <a class="reference internal" href="api.html#_CPPv4N2kv5StoreE" title="kv::Store"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Store</span></code></a> is a collection of <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Maps</span></code> that are available from all the end-points of an application. There is one unique <code class="docutils literal notranslate"><span class="pre">Store</span></code> created in the enclave of each node that is passed to the constructor of all applications.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Store</span> <span class="n">tables</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="creating-a-map">
<h2>Creating a Map<a class="headerlink" href="#creating-a-map" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="api.html#_CPPv4N2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> (often referred to as a <code class="docutils literal notranslate"><span class="pre">Table</span></code>) is a collection of key-value pairs of a given type. The <a class="reference internal" href="api.html#_CPPv4N2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> itself is identified by its name, which is used to lookup the map <a class="reference internal" href="api.html#_CPPv4N2kv3MapE" title="kv::Map"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Map</span></code></a> in a <cite>cpp:class:`kv::Store</cite> during a transaction.</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">Map</span></code> with the given name did not previously exist, it will be created in this transaction..</p>
<p>A <code class="docutils literal notranslate"><span class="pre">Map</span></code> can either be created as private (default) or public. Public map’s names begin with a <code class="docutils literal notranslate"><span class="pre">public:</span></code> prefix, any any other name indicates a private map. Transactions on private maps are written to the ledger in encrypted form and can only be decrypted in the enclave of the nodes that have joined the network. Transactions on public maps are written to the ledger as plaintext and can be read from outside the enclave (only their integrity is protected). The security domain of a map (public or private) cannot be changed after its creation, since this is encoded in the map’s name. Public and private maps with similar names are distinct; writes to “public:foo” have no impact on “foo”, and vice versa.</p>
</div>
<div class="section" id="accessing-the-transaction">
<h2>Accessing the <code class="docutils literal notranslate"><span class="pre">Transaction</span></code><a class="headerlink" href="#accessing-the-transaction" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="api.html#_CPPv4N2kv2TxE" title="kv::Tx"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Tx</span></code></a> corresponds to the atomic operations that can be executed on the Key-Value <code class="docutils literal notranslate"><span class="pre">Store</span></code>. A transaction can affect one or multiple <code class="docutils literal notranslate"><span class="pre">Map</span></code> and are automatically committed by CCF once the endpoint’s handler returns successfully.</p>
<p>A single <code class="docutils literal notranslate"><span class="pre">Transaction</span></code> (<code class="docutils literal notranslate"><span class="pre">tx</span></code>) is passed to each endpoint of an application and should be used to interact with the Key-Value <code class="docutils literal notranslate"><span class="pre">Store</span></code>.</p>
<p>When the end-point successfully completes, the node on which the end-point was triggered attempts to commit the transaction to apply the changes to the Store. Once the transaction is committed successfully, it is automatically replicated by CCF and should globally commit.</p>
<p>For each <code class="docutils literal notranslate"><span class="pre">Map</span></code> that a Transaction wants to write to or read from, a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView</span></code> should first be acquired. This may be retrieved either purely by name (in which case the desired type must be explicitly specified as template parameters), or by using a <code class="docutils literal notranslate"><span class="pre">Map</span></code> which contains both the name and the desired types.</p>
<p>By name:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// View on map1</span>
<span class="k">auto</span> <span class="n">view_map1</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="o">&lt;</span><span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&quot;map1&quot;</span><span class="p">);</span>

<span class="c1">// Two Views created at the same time, over different public and private maps</span>
<span class="k">auto</span> <span class="p">[</span><span class="n">view_map2</span><span class="p">,</span> <span class="n">view_map3</span><span class="p">]</span> <span class="o">=</span>
    <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="o">&lt;</span><span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&quot;public:map2&quot;</span><span class="p">,</span> <span class="s">&quot;map3&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>By <code class="docutils literal notranslate"><span class="pre">Map</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// View on map1</span>
<span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">map_priv</span><span class="p">(</span><span class="s">&quot;map1&quot;</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">view_map1</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span>

<span class="c1">// Two Views created at the same time, over different public and private maps</span>
<span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">map_pub</span><span class="p">(</span><span class="s">&quot;public:map2&quot;</span><span class="p">);</span>
<span class="n">kv</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">map_priv_int</span><span class="p">(</span><span class="s">&quot;map3&quot;</span><span class="p">);</span>
<span class="k">auto</span> <span class="p">[</span><span class="n">view_map2</span><span class="p">,</span> <span class="n">view_map3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">map_pub</span><span class="p">,</span> <span class="n">map_priv_int</span><span class="p">);</span>
</pre></div>
</div>
<p>The latter approach introduces a named binding between the map’s name and the types of its keys and values, reducing the chance for errors where code attempts to read a map with the wrong type.</p>
<p>As noted above, this access may cause the <code class="docutils literal notranslate"><span class="pre">Map</span></code> to be created, if it did not previously. In fact all <code class="docutils literal notranslate"><span class="pre">Maps</span></code> are created like this, in the first transaction in which they are accessed. Within a transaction, a newly created map behaves exactly the same as an existing map with no keys - there is no way to tell the difference, and this distinction should not matter to the transaction logic. Any writes to a newly created <code class="docutils literal notranslate"><span class="pre">Map</span></code> will be persisted when the transaction commits, and future transactions will be able to access this <code class="docutils literal notranslate"><span class="pre">Map</span></code> by name.</p>
</div>
<div class="section" id="modifying-a-view">
<h2>Modifying a <code class="docutils literal notranslate"><span class="pre">View</span></code><a class="headerlink" href="#modifying-a-view" title="Permalink to this headline">¶</a></h2>
<p>Once a <code class="docutils literal notranslate"><span class="pre">View</span></code> on a specific <code class="docutils literal notranslate"><span class="pre">Map</span></code> has been obtained, it is possible to:</p>
<ul class="simple">
<li><p>write (<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView::put</span></code>) a new value for a key;</p></li>
<li><p>read (<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView::get</span></code>) the value associated with a key;</p></li>
<li><p>delete (<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView::remove</span></code>) a Key-Value pair.</p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Writing to a View over map_priv</span>
<span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">,</span> <span class="s">&quot;value1&quot;</span><span class="p">);</span>

<span class="c1">// Reading from that View</span>
<span class="k">auto</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;value1&quot;</span><span class="p">);</span>

<span class="c1">// Removing the only key-pair in that View</span>
<span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span>

<span class="c1">// View is now empty</span>
<span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">==</span> <span class="nb">false</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="read-only-views">
<h2>Read-only views<a class="headerlink" href="#read-only-views" title="Permalink to this headline">¶</a></h2>
<p>For operations which only read from a map, it is possible to retrieve a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::ReadOnlyTxView</span></code> which only supports the <cite>get</cite> operation:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Read-only view on map_priv</span>
<span class="k">auto</span> <span class="n">view_map1</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_read_only_view</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span>

<span class="c1">// Reading from that view</span>
<span class="k">auto</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;value1&quot;</span><span class="p">);</span>

<span class="c1">// Writes are blocked at compile time</span>
<span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">,</span> <span class="s">&quot;value2&quot;</span><span class="p">);</span> <span class="c1">// Does not compile</span>
<span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span> <span class="c1">// Does not compile</span>
</pre></div>
</div>
</div>
<div class="section" id="removing-a-key">
<h2>Removing a key<a class="headerlink" href="#removing-a-key" title="Permalink to this headline">¶</a></h2>
<p>If a Key-Value pair was written to a <code class="docutils literal notranslate"><span class="pre">Map</span></code> by a previous <code class="docutils literal notranslate"><span class="pre">Transaction</span></code>, it is possible to delete this key. Because of the append-only nature of the <code class="docutils literal notranslate"><span class="pre">Store</span></code>, this Key-Value pair is not actually removed from the <code class="docutils literal notranslate"><span class="pre">Map</span></code> but instead explicitly marked as deleted from the version that the corresponding <code class="docutils literal notranslate"><span class="pre">Transaction</span></code> is committed at.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assuming that &quot;key1&quot; has already been committed</span>
<span class="n">kv</span><span class="o">::</span><span class="n">Tx</span> <span class="n">tx</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">view_map1</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">v</span> <span class="o">=</span> <span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span> <span class="c1">// v.value() == &quot;value1&quot;</span>
<span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>

<span class="c1">// New Transaction</span>
<span class="n">kv</span><span class="o">::</span><span class="n">Tx</span> <span class="n">tx_new</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">view_map1_new</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">view_map1_new</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span> <span class="c1">// v1.has_value() == false</span>
</pre></div>
</div>
</div>
<div class="section" id="global-commit">
<h2>Global commit<a class="headerlink" href="#global-commit" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">Map</span></code> is globally committed at a specific <a class="reference internal" href="api.html#_CPPv4N2kv7VersionE" title="kv::Version"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">kv::Version</span></code></a> when it is not possible to access the state of that <code class="docutils literal notranslate"><span class="pre">Map</span></code> prior to that version.
This is useful when it is certain that the state of the <code class="docutils literal notranslate"><span class="pre">Store</span></code> prior to a specific version will never need to be read or modified. A transaction is automatically globally committed once the consensus protocol has established that a majority of nodes in the CCF network have successfully committed that transaction.</p>
<p>The <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView::get_globally_committed</span></code> member function returns the value of a key that we know has been globally committed.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assuming that &quot;key1&quot;:&quot;value1&quot; has already been committed</span>
<span class="k">auto</span> <span class="n">view_map1</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span>

<span class="c1">// &quot;key1&quot; has not yet been globally committed</span>
<span class="k">auto</span> <span class="n">v</span> <span class="o">=</span> <span class="n">view_map1</span><span class="p">.</span><span class="n">get_globally_committed</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">==</span> <span class="nb">false</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Meanwhile, the CCF network globally commits the transaction in which &quot;key1&quot; was written</span>
<span class="k">auto</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">view_map1</span><span class="p">.</span><span class="n">get_globally_committed</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">);</span> <span class="c1">// v1.has_value() == &quot;value1&quot;</span>
<span class="n">assert</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;value1&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="miscellaneous">
<h2>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h2>
<div class="section" id="foreach">
<h3><code class="docutils literal notranslate"><span class="pre">foreach()</span></code><a class="headerlink" href="#foreach" title="Permalink to this headline">¶</a></h3>
<p>Key-value pairs can only be retrieved (<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView::get</span></code>) from a key. However, it is sometimes necessary to access the key for a given value.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">View</span></code> offers a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView::foreach</span></code> member function to iterate over all the elements written to that <code class="docutils literal notranslate"><span class="pre">Map</span></code> so far and run a lambda function for each Key-Value pair. Note that a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Map::TxView::foreach</span></code> loop can be ended early by returning <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="c1">// Assuming that &quot;key1&quot;:&quot;value1&quot; and &quot;key2&quot;:&quot;value2&quot; have already been committed</span>
<span class="n">kv</span><span class="o">::</span><span class="n">Tx</span> <span class="n">tx</span><span class="p">;</span>
<span class="k">auto</span> <span class="n">view_map1</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">map_priv</span><span class="p">);</span>

<span class="c1">// Outputs:</span>
<span class="c1">//  key: key1 - value: value1</span>
<span class="c1">//  key: key2 - value: value2</span>
<span class="n">view_map1</span><span class="o">-&gt;</span><span class="n">foreach</span><span class="p">([](</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; key: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">key</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - value: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="cm">/* condition*/</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="applying-and-reverting-writes">
<h3>Applying and reverting writes<a class="headerlink" href="#applying-and-reverting-writes" title="Permalink to this headline">¶</a></h3>
<p>Changes to the <code class="docutils literal notranslate"><span class="pre">Store</span></code> are made by atomic transactions. For a given <a class="reference internal" href="api.html#_CPPv4N2kv2TxE" title="kv::Tx"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">kv::Tx</span></code></a>, either all of its writes are applied, or none are. Only applied writes are replicated and may be globally committed. Transactions may be abandoned without applying their writes - their changes will never be seen by other transactions.</p>
<p>By default CCF decides which transactions are successful (so should be applied to the persistent store) by looking at the status code contained in the response: all transactions producing <code class="docutils literal notranslate"><span class="pre">2xx</span></code> status codes will be applied, while any other status code will be treated as an error and will <cite>not</cite> be applied to the persistent store. If this behaviour is not desired, for instance when an app wants to log incoming requests even though they produce an error, then it can be dynamically overridden by explicitly telling CCF whether it should apply a given transaction:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">args</span><span class="p">.</span><span class="n">rpc_ctx</span><span class="o">-&gt;</span><span class="n">set_response_status</span><span class="p">(</span><span class="n">HTTP_STATUS_FORBIDDEN</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">forbidden_requests_view</span> <span class="o">=</span> <span class="n">tx</span><span class="p">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">forbidden_requests</span><span class="p">);</span>

<span class="c1">// Log details of forbidden request</span>
<span class="n">forbidden_requests_view</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(...);</span>

 <span class="c1">// Apply this, even though it has an error response</span>
<span class="n">args</span><span class="p">.</span><span class="n">rpc_ctx</span><span class="o">-&gt;</span><span class="n">set_apply_writes</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="index.html" title="previous page">Key-Value Store</a>
    <a class='right-next' id="next-link" href="kv_serialisation.html" title="next page">KV Serialisation</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../_static/js/index.d3f166471bb80abb5163.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2018, Microsoft Research.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>