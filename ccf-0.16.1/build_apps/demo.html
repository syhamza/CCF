
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>End-to-end demo &#8212; CCF  documentation</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="User Authentication" href="auth/index.html" />
    <link rel="prev" title="Running CCF Applications" href="run_app.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

    
    <a class="navbar-brand" href="../index.html">
      <img src="../_static/ccf.svg" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-11 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../overview/index.html">Overview</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="index.html">Build Apps</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../use_apps/index.html">Use Apps</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../operations/index.html">Operations</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../governance/index.html">Governance</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../audit/index.html">Audit</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../glossary.html">Glossary</a>
        </li>
        
        
      </ul>

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/Microsoft/CCF" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<script>
    function onVersionChange() {
      window.location.href = document.getElementById("versions").value;
    }

    window.addEventListener("DOMContentLoaded",function(){
        let selectedVersion = "master"
        const thisURL = window.location.toString()
        let indexOfVersion = thisURL.indexOf("ccf-")
        if (indexOfVersion != -1) {
            selectedVersion = thisURL.substring(indexOfVersion, thisURL.indexOf("/", indexOfVersion));
        }
        let sel = document.getElementById("versions");
        if (sel != null) {
            let opts = sel.options;
            for (var opt, j = 0; opt = opts[j]; j++) {
                if (opt.text == selectedVersion) {
                    sel.selectedIndex = j;
                    break;
                }
            }
        }
    }, false);
</script>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
        

        <ul class="nav bd-sidenav">
            
            
            
            
            
            
            <li class="">
                <a href="example.html">C++ Application</a>
            </li>
            
            
            
            <li class="">
                <a href="js_app.html">JavaScript Application</a>
            </li>
            
            
            
            <li class="">
                <a href="build_app.html">Build and Sign CCF Applications</a>
            </li>
            
            
            
            <li class="">
                <a href="run_app.html">Running CCF Applications</a>
            </li>
            
            
            
            <li class="active">
                <a href="">End-to-end demo</a>
            </li>
            
            
            
            <li class="">
                <a href="auth/index.html">User Authentication</a>
            </li>
            
            
            
            <li class="">
                <a href="kv/index.html">Key-Value Store</a>
            </li>
            
            
            
            <li class="">
                <a href="upgrading_app.html">Upgrade Your Application</a>
            </li>
            
            
            
            <li class="">
                <a href="api.html">Developer API</a>
            </li>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </ul>

        
        <h6> Versions </h6>
        <select name="versions" id="versions" class="custom-select custom-select-sm" style="width:50%" onchange="onVersionChange()">
            <option value="../../master/build_apps/demo.html">master </option>
            <option value="../../ccf-0.17.2/build_apps/demo.html">ccf-0.17.2 </option>
            <option value="../../ccf-0.17.1/build_apps/demo.html">ccf-0.17.1 </option>
            <option value="../../ccf-0.17.0/build_apps/demo.html">ccf-0.17.0 </option>
            <option value="../../ccf-0.16.3/build_apps/demo.html">ccf-0.16.3 </option>
            <option value="../../ccf-0.16.2/build_apps/demo.html">ccf-0.16.2 </option>
            <option value="demo.html">ccf-0.16.1 </option>
            <option value="../../ccf-0.16.0/build_apps/demo.html">ccf-0.16.0 </option>
            <option value="../../ccf-0.15.2/index.html">ccf-0.15.2 </option>
            <option value="../../ccf-0.15.1/index.html">ccf-0.15.1 </option>
            <option value="../../ccf-0.15.0/index.html">ccf-0.15.0 </option>
            <option value="../../ccf-0.14.3/index.html">ccf-0.14.3 </option>
            <option value="../../ccf-0.14.2/index.html">ccf-0.14.2 </option>
            <option value="../../ccf-0.14.1/index.html">ccf-0.14.1 </option>
            <option value="../../ccf-0.14.0/index.html">ccf-0.14.0 </option>
            <option value="../../ccf-0.13.4/index.html">ccf-0.13.4 </option>
            <option value="../../ccf-0.13.3/index.html">ccf-0.13.3 </option>
            <option value="../../ccf-0.13.2/index.html">ccf-0.13.2 </option>
            <option value="../../ccf-0.13.1/index.html">ccf-0.13.1 </option>
            <option value="../../ccf-0.13.0/index.html">ccf-0.13.0 </option>
            <option value="../../ccf-0.12.2/index.html">ccf-0.12.2 </option>
            <option value="../../ccf-0.12.1/index.html">ccf-0.12.1 </option>
            <option value="../../ccf-0.12.0/index.html">ccf-0.12.0 </option>
            <option value="../../ccf-0.11.7/index.html">ccf-0.11.7 </option>
            <option value="../../ccf-0.11.4/index.html">ccf-0.11.4 </option>
            <option value="../../ccf-0.11.1/index.html">ccf-0.11.1 </option>
        </select>
        
</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#startup" class="nav-link">Startup</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#authentication" class="nav-link">Authentication</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#basic-commands" class="nav-link">Basic Commands</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#logging-app-commands" class="nav-link">Logging App Commands</a>
        </li>
    
    </ul>
</nav>



<div class="tocsection editthispage">
    <a href="https://github.com/Microsoft/CCF/edit/master/doc/build_apps/demo.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="end-to-end-demo">
<h1>End-to-end demo<a class="headerlink" href="#end-to-end-demo" title="Permalink to this headline">¶</a></h1>
<p>This document explains how to spin up a test CCF network and submit simple commands to it using <a class="reference external" href="https://curl.haxx.se/">curl</a>. We use curl here because it is a standard tool and broadly available - you should be able to get the same results with any HTTP client, provided you can configure the appropriate caller and CA identities. Once you have built your own app, you should be able to test it in the same way - simply replace <code class="docutils literal notranslate"><span class="pre">liblogging</span></code> with the name of your app binary, and call the endpoints defined by your app.</p>
<div class="section" id="startup">
<h2>Startup<a class="headerlink" href="#startup" title="Permalink to this headline">¶</a></h2>
<p>This uses the <a class="reference internal" href="logging_cpp.html#logging-c"><span class="std std-ref">example C++ logging app</span></a> and the <code class="docutils literal notranslate"><span class="pre">sandbox.sh</span></code> helper script included in CCF releases under the ‘bin’ directory.</p>
<p><code class="docutils literal notranslate"><span class="pre">sandbox.sh</span></code> is a thin wrapper around <code class="docutils literal notranslate"><span class="pre">start_network.py</span></code>. It ensures the necessary Python dependencies are available and sets some sensible default values.
There are a large number of additional configuration options, documented by passing the <code class="docutils literal notranslate"><span class="pre">--help</span></code> argument. You may wish to pass <code class="docutils literal notranslate"><span class="pre">-v</span></code> which will make the script significantly more verbose, printing the precise <code class="docutils literal notranslate"><span class="pre">curl</span></code> commands which were used to communicate with the test network.</p>
<p>This script automates the steps described in <a class="reference internal" href="../operations/start_network.html"><span class="doc">Running a CCF Service</span></a>, in summary:</p>
<ul class="simple">
<li><p>generating new identities (private keys and certs) for the initial members and users</p></li>
<li><p>starting the initial <code class="docutils literal notranslate"><span class="pre">cchost</span></code> node</p></li>
<li><p>starting multiple additional nodes, instructed to <code class="docutils literal notranslate"><span class="pre">join</span></code> the initial node</p></li>
<li><p>verifying that each node has successfully joined the new service</p></li>
<li><p>proposing and passing governance votes using the generated member identities</p></li>
</ul>
<p>The following command will run a simple one node test network on a single machine:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> CCF/build

$ ../tests/sandbox.sh -p ./liblogging.virtual.so
Setting up Python environment...
Python environment successfully setup
<span class="o">[</span><span class="m">16</span>:14:05.294<span class="o">]</span> Starting <span class="m">1</span> CCF node...
<span class="o">[</span><span class="m">16</span>:14:05.295<span class="o">]</span> Virtual mode enabled
<span class="o">[</span><span class="m">16</span>:14:10.010<span class="o">]</span> Started CCF network with the following nodes:
<span class="o">[</span><span class="m">16</span>:14:10.011<span class="o">]</span>   Node <span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="o">=</span> https://127.0.0.1:8000
<span class="o">[</span><span class="m">16</span>:14:10.011<span class="o">]</span> You can now issue business transactions to the ./liblogging.virtual.so application.
<span class="o">[</span><span class="m">16</span>:14:10.011<span class="o">]</span> Keys and certificates have been copied to the common folder: /data/src/CCF/build/workspace/sandbox_common
<span class="o">[</span><span class="m">16</span>:14:10.011<span class="o">]</span> See https://microsoft.github.io/CCF/master/use_apps/issue_commands.html <span class="k">for</span> more information.
<span class="o">[</span><span class="m">16</span>:14:10.011<span class="o">]</span> Press Ctrl+C to shutdown the network.
</pre></div>
</div>
<p>The command output shows the addresses of the CCF nodes where commands may be submitted (eg, in this case, via <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">https://127.0.0.1:8000/...</span></code>).
The output and error logs of each node can be found in the node-specific directory in the workspace (eg, <code class="docutils literal notranslate"><span class="pre">workspace/sandbox_0/err</span></code> is node 0’s stderr).</p>
</div>
<div class="section" id="authentication">
<h2>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h2>
<p>When establishing a TLS connection with a CCF service both the service and client must prove their identity.</p>
<p>The service identity is created at startup. The initial node generates a fresh private key which exists solely within the service’s enclaves. A certificate of the corresponding public key is emitted (<code class="docutils literal notranslate"><span class="pre">networkcert.pem</span></code>) and used by all subsequent connections to confirm they are communicating with the intended service.</p>
<p>Each member and user is identified by the cert with which they were registered with the service, either at genesis or in a subsequent <code class="docutils literal notranslate"><span class="pre">new_member</span></code> or <code class="docutils literal notranslate"><span class="pre">new_user</span></code> governance proposal. Access to the corresponding private key allows a client to submit commands as this member or user. For this test network these are all freshly generated and stored in the same common workspace for easy access. In a real deployment only the certificates would be shared; the private keys would be distributed and remain confidential.</p>
<p>When using curl the server’s identity is provided by <code class="docutils literal notranslate"><span class="pre">--cacert</span></code> and the client identity by <code class="docutils literal notranslate"><span class="pre">--cert</span></code> and <code class="docutils literal notranslate"><span class="pre">--key</span></code>. Resources under the <code class="docutils literal notranslate"><span class="pre">/gov</span></code> path require member identities, while those under <code class="docutils literal notranslate"><span class="pre">/app</span></code> typically require user identities.</p>
<p>These certificates and keys are copied by the sandbox script to the common workspace directory, displayed by the start network script. By default this is <code class="docutils literal notranslate"><span class="pre">workspace/sandbox_common</span></code>.</p>
</div>
<div class="section" id="basic-commands">
<h2>Basic Commands<a class="headerlink" href="#basic-commands" title="Permalink to this headline">¶</a></h2>
<p>For ease of access, we copy the generated PEMs to the current directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cp workspace/sandbox_common/*.pem .
</pre></div>
</div>
<p>Now we can submit a first command, to find the current commit index of the test network:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl https://127.251.192.205:36981/app/commit -X GET --cacert networkcert.pem --cert user0_cert.pem --key user0_privk.pem
<span class="o">{</span><span class="s2">&quot;seqno&quot;</span>:30,<span class="s2">&quot;view&quot;</span>:2<span class="o">}</span>
</pre></div>
</div>
<p>This should look much like a standard HTTP server, with error codes for missing resources or resources the caller is not authorized to access:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl https://127.251.192.205:36981/app/not/a/real/resource -X GET --cacert networkcert.pem --cert user0_cert.pem --key user0_privk.pem -i
HTTP/1.1 <span class="m">404</span> Not Found

$ curl https://127.251.192.205:36981/gov/proposals -X POST --cacert networkcert.pem --cert user0_cert.pem --key user0_privk.pem -i
HTTP/1.1 <span class="m">403</span> Forbidden
</pre></div>
</div>
</div>
<div class="section" id="logging-app-commands">
<h2>Logging App Commands<a class="headerlink" href="#logging-app-commands" title="Permalink to this headline">¶</a></h2>
<p>The business transaction endpoints defined by our application are available under the <code class="docutils literal notranslate"><span class="pre">/app</span></code> prefix. For example, consider the <code class="docutils literal notranslate"><span class="pre">&quot;log/private&quot;</span></code> endpoint installed by the C++ logging application:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">make_endpoint</span><span class="p">(</span><span class="s">&quot;log/private&quot;</span><span class="p">,</span> <span class="n">HTTP_POST</span><span class="p">,</span> <span class="n">ccf</span><span class="o">::</span><span class="n">json_adapter</span><span class="p">(</span><span class="n">record</span><span class="p">))</span>
  <span class="p">.</span><span class="n">set_auto_schema</span><span class="o">&lt;</span><span class="n">LoggingRecord</span><span class="o">::</span><span class="n">In</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">.</span><span class="n">add_authentication</span><span class="p">(</span><span class="n">user_cert_auth_policy</span><span class="p">)</span>
  <span class="p">.</span><span class="n">install</span><span class="p">();</span>
</pre></div>
</div>
<p>This is available at the <code class="docutils literal notranslate"><span class="pre">/app/log/private</span></code> path:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl https://127.251.192.205:36981/app/log/private -X POST --cacert networkcert.pem --cert user0_cert.pem --key user0_privk.pem -H <span class="s2">&quot;Content-Type: application/json&quot;</span> --data-binary <span class="s1">&#39;{&quot;id&quot;: 42, &quot;msg&quot;: &quot;Logged to private table&quot;}&#39;</span>
<span class="nb">true</span>
</pre></div>
</div>
<p>This has written an entry to the CCF KV, which can be retrieved by a future request:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl https://127.251.192.205:36981/app/log/private?id<span class="o">=</span><span class="m">42</span> -X GET --cacert networkcert.pem --cert user0_cert.pem --key user0_privk.pem
<span class="o">{</span><span class="s2">&quot;msg&quot;</span>:<span class="s2">&quot;Logged to private table&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>We can log messages in the public table via the <code class="docutils literal notranslate"><span class="pre">/app/log/public</span></code> path:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl https://127.251.192.205:36981/app/log/public -X POST --cacert networkcert.pem --cert user0_cert.pem --key user0_privk.pem -H <span class="s2">&quot;Content-Type: application/json&quot;</span> --data-binary <span class="s1">&#39;{&quot;id&quot;: 42, &quot;msg&quot;: &quot;Logged to public table&quot;}&#39;</span>
<span class="nb">true</span>

$ curl https://127.251.192.205:36981/app/log/public?id<span class="o">=</span><span class="m">42</span> -X GET --cacert networkcert.pem --cert user0_cert.pem --key user0_privk.pem
<span class="o">{</span><span class="s2">&quot;msg&quot;</span>:<span class="s2">&quot;Logged to public table&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>Note that the paths to these handlers is arbitrary. The names of the endpoints do not affect whether the result works with public or private tables - that is determined entirely by the application code. The logging app contains very simple examples, and real business transactions are likely to read and write from multiple tables. The difference between public and private tables is that private tables are encrypted before being written to the ledger, so their contents are only visible within the service’s enclaves, whereas public tables can be read and audited directly from the ledger. This can be crudely checked by grepping the produced ledger files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ grep <span class="s2">&quot;Logged to public table&quot;</span> workspace/sandbox_0/0.ledger/ledger_1 -q <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Visible&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;Not visible&quot;</span>
Visible

$ grep <span class="s2">&quot;Logged to private table&quot;</span> workspace/sandbox_0/0.ledger/ledger_1 -q <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Visible&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;Not visible&quot;</span>
Not visible
</pre></div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="run_app.html" title="previous page">Running CCF Applications</a>
    <a class='right-next' id="next-link" href="auth/index.html" title="next page">User Authentication</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2018, Microsoft Research.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>